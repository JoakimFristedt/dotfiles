#!/usr/bin/env bash

command -v kafkacat > /dev/null 2>&1 || {
  echo >&2 "kafka: I require kafkacat, but it's not installed. Aborting.";
  exit 1;
}

command -v fzf > /dev/null 2>&1 || {
  echo >&2 "kafka: I require fzf, but it's not installed. Aborting.";
  exit 1;
}

if [ -f .kafka_config ]; then
  source .kafka_config
else
  KAFKA_BROKER="localhost:9092"
  KAFKA_USERNAME=""
  KAFKA_PASSWORD=""
fi

if [ -z $KAFKA_USERNAME ]; then
  KAFKA_SECURITY_OPTS=""
else
  KAFKA_SECURITY_OPTS="-X security.protocol=SASL_SSL \
    -X sasl.username=$KAFKA_USERNAME \
    -X sasl.password=$KAFKA_PASSWORD \
    -X sasl.mechanisms=PLAIN"
fi

function _list_metadata_for_all_topics() {
  kafkacat \
    -L \
    $KAFKA_SECURITY_OPTS \
    -b $KAFKA_BROKER
}

function _list_topics() {
  _list_metadata_for_all_topics | grep "topic\s\"" | cut -d "\"" -f 2
}

function _consume_topic() {
  if [ -z $TOPIC ]; then
    TOPIC=$(_list_topics | fzf)
  fi
  kafkacat \
    -C \
    $KAFKA_SECURITY_OPTS \
    -b $KAFKA_BROKER \
    -t $TOPIC
}

POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
    -L | list)
    shift
		_list_topics
    ;;
    -C | consume)
    shift
    _consume_topic
    ;;
    -M | metadata)
    shift
    _list_metadata_for_all_topics
    ;;
    -t | --topic)
    shift
    TOPIC="$1"
    shift
    ;;
    -v | --verbose)
    echo "Topic: " $TOPIC
    echo "Broker: " $KAFKA_BROKER
    shift
    ;;
    *)
    POSITIONAL+=("$1")
    shift
    ;;
esac
done
